<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kerala Quest - The Ultimate Calicut Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a1a;
            touch-action: pan-x pan-y;
            overflow: hidden; /* Prevent body scroll, handle in app container */
        }

        /* Specific Kerala Themes */
        .kerala-gradient {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
        }
        .calicut-sunset {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .backwater-blue {
            background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            height: 100dvh; /* Dynamic viewport height */
            background: #f8fafc;
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
        .coconut { position: absolute; font-size: 2rem; }

        /* Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Game Canvas */
        #gameCanvas { background: #e0f2fe; touch-action: none; }
    </style>
</head>
<body class="bg-gray-900 flex justify-center items-center h-screen">

    <div class="mobile-container w-full" id="app">
        <!-- SPLASH SCREEN INITIALLY -->
        <div id="splash" class="absolute inset-0 z-50 kerala-gradient flex flex-col items-center justify-center text-white">
            <i class="fas fa-compass text-6xl mb-4 animate-float"></i>
            <h1 class="text-4xl font-bold tracking-tighter">Kerala Quest</h1>
            <p class="text-emerald-100 mt-2 tracking-widest text-sm uppercase">Calicut Edition</p>
            <div class="mt-8 w-48 h-1 bg-white/30 rounded-full overflow-hidden">
                <div class="h-full bg-white animate-[pulse_1.5s_infinite]"></div>
            </div>
            <p class="absolute bottom-8 text-xs opacity-70">Loading Offline Maps...</p>
        </div>
    </div>

    <script>
        // --- DATA & STATE MANAGEMENT ---
        
        const LOCATIONS = [
            { id: 1, name: "Calicut Beach", desc: "Find the broken bridge.", lat: 11.24, lng: 75.77 },
            { id: 2, name: "Mananchira", desc: "The ancient water tank.", lat: 11.25, lng: 75.77 },
            { id: 3, name: "SM Street", desc: "The street of sweets.", lat: 11.25, lng: 75.78 },
            { id: 4, name: "Beypore", desc: "Where ships are born.", lat: 11.16, lng: 75.80 }
        ];

        const QUESTS = [
            { 
                id: 1, 
                zone: "Calicut Beach", 
                title: "The Pier's Secret",
                riddle: "I reach for the sea but cannot swim. Find the pillar marked with the year of independence.",
                code: "1947",
                points: 500,
                hint: "Look near the ice pickle sellers."
            },
            { 
                id: 2, 
                zone: "Mananchira", 
                title: "The Green Guardian",
                riddle: "Surrounded by books and walls of old. I watch the water but never drink.",
                code: "LIBRARY",
                points: 750,
                hint: "Public Library entrance."
            }
        ];

        const BADGES = [
            { name: "Beach Bum", icon: "üèñÔ∏è", desc: "Visited Calicut Beach" },
            { name: "Sweet Tooth", icon: "üç¨", desc: "Solved SM Street" },
            { name: "Navigator", icon: "üß≠", desc: "Found 5 locations" }
        ];

        // Global State
        const state = {
            view: 'splash', // splash, login, admin, volunteer, player
            user: { role: null, name: 'Guest', points: 1250, badges: [BADGES[0]] },
            activeTab: 'home', // home, social, profile, leaderboard
            game: {
                active: false,
                score: 0,
                lives: 3,
                interval: null
            },
            chat: {
                open: false,
                partner: null,
                messages: []
            },
            players: [
                { id: 1, name: "Adnan", status: "public", dist: "10m", avatar: "üßî" },
                { id: 2, name: "Riya", status: "public", dist: "45m", avatar: "üë©‚Äçü¶±" },
                { id: 3, name: "Kiran", status: "private", dist: "120m", avatar: "üßë" }
            ]
        };

        // --- CORE FUNCTIONS ---

        const app = document.getElementById('app');

        function init() {
            setTimeout(() => {
                state.view = 'login';
                render();
            }, 2500);
        }

        function render() {
            app.innerHTML = '';
            
            // Render specific view based on state
            switch(state.view) {
                case 'login': renderLogin(); break;
                case 'admin': renderAdmin(); break;
                case 'volunteer': renderVolunteer(); break;
                case 'player': renderPlayer(); break;
            }

            // Global Overlay Components
            if (state.game.active) renderMiniGame();
            if (state.chat.open) renderChatModal();
        }

        // --- VIEW RENDERERS ---

        function renderLogin() {
            app.innerHTML = `
                <div class="flex-1 flex flex-col justify-between p-8 bg-white relative overflow-hidden">
                    <!-- Background Elements -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 -translate-y-1/2 translate-x-1/2"></div>
                    <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 translate-y-1/2 -translate-x-1/2"></div>

                    <div class="relative z-10 pt-12">
                        <div class="w-20 h-20 bg-emerald-500 rounded-2xl flex items-center justify-center text-white text-4xl shadow-lg shadow-emerald-200 mb-6 mx-auto rotate-3">
                            <i class="fas fa-map-location-dot"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800 text-center">Welcome Back</h1>
                        <p class="text-center text-gray-500 mt-2">Select your role to continue</p>
                    </div>
                    
                    <div class="space-y-4 relative z-10 mb-8">
                        <button onclick="login('player')" class="w-full p-4 bg-white border-2 border-emerald-100 rounded-2xl flex items-center gap-4 shadow-sm hover:border-emerald-500 hover:shadow-emerald-100 transition-all group">
                            <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                                <i class="fas fa-gamepad text-xl"></i>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800">Player</h3>
                                <p class="text-xs text-gray-400">Join the hunt & mingle</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-300"></i>
                        </button>

                        <button onclick="login('volunteer')" class="w-full p-4 bg-white border-2 border-blue-100 rounded-2xl flex items-center gap-4 shadow-sm hover:border-blue-500 hover:shadow-blue-100 transition-all group">
                            <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                <i class="fas fa-id-badge text-xl"></i>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800">Volunteer</h3>
                                <p class="text-xs text-gray-400">Manage zones & verify</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-300"></i>
                        </button>

                        <button onclick="login('admin')" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl flex items-center gap-4 shadow-sm hover:border-gray-800 transition-all group">
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 group-hover:bg-gray-800 group-hover:text-white transition-colors">
                                <i class="fas fa-server text-xl"></i>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800">Admin</h3>
                                <p class="text-xs text-gray-400">Control center</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-300"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- PLAYER VIEW ---
        function renderPlayer() {
            let content = '';
            
            if (state.activeTab === 'home') content = renderPlayerHome();
            else if (state.activeTab === 'social') content = renderPlayerSocial();
            else if (state.activeTab === 'profile') content = renderPlayerProfile();
            else if (state.activeTab === 'leaderboard') content = renderPlayerLeaderboard();

            app.innerHTML = `
                <!-- Top Nav -->
                <div class="bg-white px-6 pt-12 pb-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
                    <div>
                        <h2 class="font-bold text-lg text-gray-800">Hi, ${state.user.name} üëã</h2>
                        <div class="flex items-center gap-1 text-xs text-gray-500">
                            <i class="fas fa-map-marker-alt text-emerald-500"></i> Calicut Beach
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="bg-amber-100 text-amber-700 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1">
                            <i class="fas fa-coins"></i> ${state.user.points}
                        </div>
                        <button onclick="logout()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                            <i class="fas fa-power-off text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 pb-24">
                    ${content}
                </div>

                <!-- Bottom Tab Bar -->
                <div class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-100 flex justify-between px-6 py-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-30">
                    ${navBtn('home', 'fa-compass', 'Quest')}
                    ${navBtn('social', 'fa-users', 'Mingle')}
                    <div class="relative -top-8">
                        <button onclick="startGame()" class="w-14 h-14 rounded-full kerala-gradient flex items-center justify-center text-white shadow-lg shadow-emerald-200 transform hover:scale-105 transition">
                            <i class="fas fa-play text-xl ml-1"></i>
                        </button>
                    </div>
                    ${navBtn('leaderboard', 'fa-trophy', 'Rank')}
                    ${navBtn('profile', 'fa-user', 'Me')}
                </div>
            `;
        }

        function navBtn(id, icon, label) {
            const active = state.activeTab === id;
            return `
                <button onclick="switchTab('${id}')" class="flex flex-col items-center gap-1 w-12 ${active ? 'text-emerald-600' : 'text-gray-400'}">
                    <i class="fas ${icon} text-xl transition-colors"></i>
                    <span class="text-[10px] font-medium">${label}</span>
                </button>
            `;
        }

        function renderPlayerHome() {
            const activeQuest = QUESTS[0];
            return `
                <div class="p-6 space-y-6">
                    <!-- Status Card -->
                    <div class="w-full bg-blue-600 rounded-2xl p-6 text-white relative overflow-hidden shadow-xl shadow-blue-200">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-white/20 text-xs px-2 py-1 rounded backdrop-blur">Daily Challenge</span>
                                <span class="text-xs opacity-80"><i class="far fa-clock"></i> 2h left</span>
                            </div>
                            <h3 class="text-2xl font-bold mb-1">Catch The Coconut</h3>
                            <p class="text-blue-100 text-sm mb-4">Catch 20 coconuts to unlock a hidden clue!</p>
                            <button onclick="startGame()" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition">Play Now</button>
                        </div>
                    </div>

                    <!-- Active Quest -->
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-scroll text-emerald-500"></i> Current Quest
                        </h3>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-gray-800 text-lg">${activeQuest.title}</span>
                                <span class="text-emerald-600 font-bold text-sm">+${activeQuest.points} pts</span>
                            </div>
                            <p class="text-gray-500 text-sm italic mb-4">"${activeQuest.riddle}"</p>
                            
                            <div class="relative">
                                <input type="text" id="questInput" placeholder="Enter code found at location" 
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-emerald-500 transition">
                                <button onclick="checkCode('${activeQuest.code}')" class="absolute right-2 top-2 bottom-2 bg-emerald-500 text-white px-3 rounded-lg text-sm font-bold shadow-sm">
                                    Check
                                </button>
                            </div>
                            <button onclick="alert('${activeQuest.hint}')" class="mt-3 text-xs text-gray-400 flex items-center gap-1 hover:text-gray-600">
                                <i class="far fa-lightbulb"></i> Need a hint? (-50 pts)
                            </button>
                        </div>
                    </div>

                    <!-- Nearby Spots -->
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3">Nearby Zones</h3>
                        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-4">
                            ${LOCATIONS.map(loc => `
                                <div class="min-w-[140px] bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex-shrink-0">
                                    <div class="w-full h-24 bg-gray-100 rounded-lg mb-2 relative overflow-hidden">
                                        <!-- Placeholder Image Generation using CSS Pattern -->
                                        <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-gray-900 to-gray-100"></div>
                                        <i class="fas fa-image absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-300"></i>
                                    </div>
                                    <h4 class="font-bold text-sm text-gray-800 truncate">${loc.name}</h4>
                                    <p class="text-[10px] text-gray-400 truncate">${loc.desc}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerSocial() {
            return `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-xl text-gray-800">Social Radar</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">Visible</span>
                            <div class="w-10 h-6 bg-emerald-500 rounded-full relative cursor-pointer">
                                <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full shadow-sm"></div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${state.players.map(p => `
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="relative">
                                        <span class="text-3xl">${p.avatar}</span>
                                        <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">${p.name}</h4>
                                        <p class="text-xs text-gray-400 flex items-center gap-1">
                                            <i class="fas fa-map-pin text-[10px]"></i> ${p.dist} away
                                        </p>
                                    </div>
                                </div>
                                <button onclick="openChat('${p.name}')" class="bg-blue-50 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-blue-100 transition">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-8 bg-amber-50 border border-amber-100 p-4 rounded-xl">
                        <h4 class="font-bold text-amber-800 text-sm mb-1"><i class="fas fa-shield-alt mr-1"></i> Safety First</h4>
                        <p class="text-xs text-amber-700 leading-relaxed">Only mingle in public places like the Main Beach Promenade or Mananchira Square. Do not follow strangers to secluded areas.</p>
                    </div>
                </div>
            `;
        }

        function renderPlayerProfile() {
            return `
                <div class="p-6">
                    <div class="text-center mb-8">
                        <div class="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-3 flex items-center justify-center text-4xl border-4 border-white shadow-lg">üòé</div>
                        <h2 class="text-xl font-bold text-gray-800">${state.user.name}</h2>
                        <p class="text-sm text-gray-500">Master Explorer</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm text-center border border-gray-100">
                            <div class="text-2xl font-bold text-emerald-500">${state.user.points}</div>
                            <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Total Score</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm text-center border border-gray-100">
                            <div class="text-2xl font-bold text-blue-500">12</div>
                            <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Quests Done</div>
                        </div>
                    </div>

                    <h3 class="font-bold text-gray-800 mb-4">Badges</h3>
                    <div class="grid grid-cols-3 gap-3">
                        ${BADGES.map(b => `
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center text-center">
                                <div class="text-2xl mb-1">${b.icon}</div>
                                <div class="font-bold text-xs text-gray-700">${b.name}</div>
                                <div class="text-[8px] text-gray-400 mt-1">${b.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderPlayerLeaderboard() {
            const leaderboard = [
                { name: "Sneha", score: 2400, avatar: "üë©‚ÄçüöÄ" },
                { name: "Arjun", score: 2150, avatar: "üë®‚Äçüíª" },
                { name: "You", score: 1250, avatar: "üòé" },
                { name: "Rahul", score: 900, avatar: "üèÑ" }
            ];

            return `
                <div class="p-6">
                    <h3 class="font-bold text-xl text-gray-800 mb-6">Top Explorers</h3>
                    <div class="space-y-4">
                        ${leaderboard.map((p, i) => `
                            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 ${p.name === 'You' ? 'ring-2 ring-emerald-400' : ''}">
                                <div class="w-8 font-bold text-gray-400 text-lg">#${i + 1}</div>
                                <div class="text-2xl">${p.avatar}</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${p.name}</h4>
                                    <p class="text-xs text-gray-400">Level ${Math.floor(p.score/500) + 1}</p>
                                </div>
                                <div class="font-bold text-emerald-600">${p.score}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- ADMIN VIEW ---
        function renderAdmin() {
            app.innerHTML = `
                <div class="bg-gray-900 text-white p-6 sticky top-0 z-20">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold">God Mode</h2>
                            <p class="text-xs text-gray-400">Admin Control Panel</p>
                        </div>
                        <button onclick="logout()" class="text-xs bg-gray-800 px-3 py-1 rounded hover:bg-gray-700">Logout</button>
                    </div>
                    
                    <!-- Stats Row -->
                    <div class="flex gap-4 mb-2">
                        <div class="flex-1 bg-gray-800 rounded-lg p-3">
                            <div class="text-xs text-gray-400">ONLINE</div>
                            <div class="text-2xl font-bold text-green-400">142</div>
                        </div>
                        <div class="flex-1 bg-gray-800 rounded-lg p-3">
                            <div class="text-xs text-gray-400">ZONES</div>
                            <div class="text-2xl font-bold text-blue-400">4</div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-gray-100 p-6 overflow-y-auto">
                    <!-- Live Map Mock -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                        <div class="p-3 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-sm text-gray-700">Live Heatmap</h3>
                            <span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full animate-pulse">LIVE</span>
                        </div>
                        <div class="h-48 bg-gray-200 relative">
                            <!-- Simulated Map -->
                            <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 10px 10px;"></div>
                            <!-- Hotspots -->
                            <div class="absolute top-1/4 left-1/4 w-12 h-12 bg-red-500 rounded-full blur-xl opacity-60"></div>
                            <div class="absolute bottom-1/3 right-1/4 w-16 h-16 bg-red-500 rounded-full blur-xl opacity-40"></div>
                            
                            <div class="absolute bottom-2 left-2 text-[10px] text-gray-500 bg-white/80 px-2 rounded">Calicut Map View</div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <h3 class="font-bold text-gray-700 mb-3 text-sm">Event Controls</h3>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="alert('Starting Global Event!')" class="bg-emerald-600 text-white p-3 rounded-xl font-bold text-sm shadow-lg shadow-emerald-200 active:scale-95 transition">Start Hunt</button>
                        <button onclick="alert('Pausing all active games...')" class="bg-gray-800 text-white p-3 rounded-xl font-bold text-sm shadow-lg shadow-gray-400 active:scale-95 transition">Pause All</button>
                    </div>

                    <!-- Logs -->
                    <h3 class="font-bold text-gray-700 mb-3 text-sm">Live Logs</h3>
                    <div class="bg-white rounded-xl p-4 text-xs space-y-2 font-mono text-gray-600 shadow-sm h-40 overflow-y-auto">
                        <div class="flex gap-2"><span class="text-gray-400">10:42:01</span> <span>Player #892 found Pier Clue</span></div>
                        <div class="flex gap-2"><span class="text-gray-400">10:41:55</span> <span class="text-red-500">Volunteer #2 reported safety alert</span></div>
                        <div class="flex gap-2"><span class="text-gray-400">10:41:20</span> <span>New player registered</span></div>
                        <div class="flex gap-2"><span class="text-gray-400">10:40:12</span> <span>Player #102 mingled with #44</span></div>
                    </div>
                </div>
            `;
        }

        // --- VOLUNTEER VIEW ---
        function renderVolunteer() {
            app.innerHTML = `
                <div class="bg-blue-600 text-white p-6 pb-8 sticky top-0 z-20">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="font-bold text-lg">Volunteer Ops</h2>
                        <button onclick="logout()" class="text-xs bg-blue-700 px-3 py-1 rounded">Exit</button>
                    </div>
                    <p class="text-blue-200 text-xs">Zone: South Beach</p>
                </div>

                <div class="flex-1 bg-gray-50 p-6 -mt-4 rounded-t-3xl z-30 relative overflow-y-auto">
                    <!-- Scanner -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-6 text-center transform -translate-y-8">
                        <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 text-2xl animate-pulse">
                            <i class="fas fa-camera"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Verify Discovery</h3>
                        <p class="text-gray-400 text-xs mb-4">Scan player QR code to confirm treasure find.</p>
                        <button onclick="alert('Camera opening...')" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition">Open Scanner</button>
                    </div>

                    <h3 class="font-bold text-gray-700 mb-3 text-sm">Tasks Queue</h3>
                    <div class="space-y-3">
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center gap-3">
                            <div class="w-2 h-12 bg-orange-400 rounded-full"></div>
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">Restock Water Station</h4>
                                <p class="text-xs text-gray-400">Near Pier Entrance</p>
                            </div>
                            <input type="checkbox" class="w-5 h-5 accent-blue-600">
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center gap-3">
                            <div class="w-2 h-12 bg-green-400 rounded-full"></div>
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">Check-in Point B</h4>
                                <p class="text-xs text-gray-400">Crowd control required</p>
                            </div>
                            <input type="checkbox" class="w-5 h-5 accent-blue-600">
                        </div>
                    </div>
                </div>
            `;
        }


        // --- COMPONENTS & MODALS ---

        function renderMiniGame() {
            // Overlay for Coconut Catch Game
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center";
            modal.innerHTML = `
                <div class="w-full max-w-md h-full max-h-[80vh] bg-sky-100 relative overflow-hidden rounded-xl mx-4">
                    <div class="absolute top-4 left-4 right-4 flex justify-between font-bold text-sky-900 z-10">
                        <span>Score: <span id="gameScore">0</span></span>
                        <button onclick="endGame()" class="bg-red-500 text-white px-3 py-1 rounded text-xs">Exit</button>
                    </div>
                    
                    <!-- Game Area -->
                    <div id="gameArea" class="absolute inset-0 mt-12">
                        <!-- Player Basket -->
                        <div id="basket" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-4xl transition-all duration-75" style="left: 50%;">üß∫</div>
                    </div>

                    <!-- Instructions -->
                    <div id="gameStartOverlay" class="absolute inset-0 bg-black/50 flex items-center justify-center flex-col text-white z-20">
                        <h2 class="text-3xl font-bold mb-2">Coconut Catch!</h2>
                        <p class="text-sm mb-6">Tap Left / Right to move</p>
                        <button onclick="initGameLogic()" class="bg-emerald-500 px-8 py-3 rounded-full font-bold animate-bounce">START</button>
                    </div>
                </div>
            `;
            app.appendChild(modal);
        }

        function renderChatModal() {
            const chatBox = document.createElement('div');
            chatBox.className = "fixed inset-x-0 bottom-0 top-20 bg-white z-50 rounded-t-3xl shadow-2xl flex flex-col animate-[float_0.3s_ease-out]";
            chatBox.innerHTML = `
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-3xl">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-xl">üë§</div>
                        <div>
                            <h3 class="font-bold">${state.chat.partner}</h3>
                            <p class="text-xs text-green-500">Online</p>
                        </div>
                    </div>
                    <button onclick="closeChat()" class="w-8 h-8 bg-gray-200 rounded-full text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                
                <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-white">
                    <div class="text-center text-xs text-gray-300 my-4">Chat started in public mode</div>
                    ${state.chat.messages.map(m => `
                        <div class="flex ${m.sender === 'me' ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] px-4 py-2 rounded-2xl text-sm ${m.sender === 'me' ? 'bg-emerald-500 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'}">
                                ${m.text}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="p-4 border-t bg-gray-50">
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="Say hello..." class="flex-1 bg-white border border-gray-200 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-emerald-500">
                        <button onclick="sendMessage()" class="bg-emerald-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            `;
            app.appendChild(chatBox);
        }


        // --- LOGIC: GAME ---

        function initGameLogic() {
            document.getElementById('gameStartOverlay').style.display = 'none';
            const gameArea = document.getElementById('gameArea');
            const basket = document.getElementById('basket');
            let basketPos = 50;
            state.game.score = 0;
            
            // Controls
            gameArea.addEventListener('pointerdown', (e) => {
                const rect = gameArea.getBoundingClientRect();
                const x = e.clientX - rect.left;
                if(x < rect.width / 2) basketPos = Math.max(10, basketPos - 20);
                else basketPos = Math.min(90, basketPos + 20);
                basket.style.left = basketPos + '%';
            });

            // Spawner
            state.game.interval = setInterval(() => {
                const coco = document.createElement('div');
                coco.innerText = 'ü••';
                coco.className = 'absolute text-2xl transition-top duration-[2000ms] linear';
                coco.style.left = Math.random() * 90 + '%';
                coco.style.top = '-30px';
                gameArea.appendChild(coco);

                // Animation
                let pos = -30;
                const fall = setInterval(() => {
                    pos += 5;
                    coco.style.top = pos + 'px';
                    
                    // Collision
                    if (pos > gameArea.offsetHeight - 60 && pos < gameArea.offsetHeight - 20) {
                        const cocoLeft = parseFloat(coco.style.left);
                        if (Math.abs(cocoLeft - basketPos) < 15) {
                            state.game.score += 10;
                            document.getElementById('gameScore').innerText = state.game.score;
                            coco.remove();
                            clearInterval(fall);
                            
                            // Visual feedback
                            const pop = document.createElement('div');
                            pop.innerText = '+10';
                            pop.className = 'absolute text-green-600 font-bold text-xl animate-bounce';
                            pop.style.left = basket.style.left;
                            pop.style.bottom = '60px';
                            gameArea.appendChild(pop);
                            setTimeout(() => pop.remove(), 500);
                        }
                    }

                    if (pos > gameArea.offsetHeight) {
                        coco.remove();
                        clearInterval(fall);
                    }
                }, 20);

            }, 800);
        }

        // --- LOGIC: GENERAL ---

        function login(role) {
            state.view = role;
            render();
        }

        function logout() {
            state.view = 'login';
            state.activeTab = 'home';
            render();
        }

        function switchTab(tab) {
            state.activeTab = tab;
            render();
        }

        function checkCode(correct) {
            const input = document.getElementById('questInput').value.trim().toUpperCase();
            if(input === correct) {
                state.user.points += 500;
                alert(`üéâ Correct! You earned 500 points! Total: ${state.user.points}`);
                render();
            } else {
                alert('‚ùå Incorrect code. Try searching nearby markers.');
            }
        }

        function startGame() {
            state.game.active = true;
            render();
        }

        function endGame() {
            state.game.active = false;
            clearInterval(state.game.interval);
            render();
        }

        function openChat(name) {
            state.chat.open = true;
            state.chat.partner = name;
            state.chat.messages = [
                { sender: 'them', text: 'Hey! Are you near the pier?' }
            ];
            render();
        }

        function closeChat() {
            state.chat.open = false;
            render();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            if(input.value.trim()) {
                state.chat.messages.push({ sender: 'me', text: input.value });
                renderChatModal(); // Re-render chat only
                
                // Mock reply
                setTimeout(() => {
                    state.chat.messages.push({ sender: 'them', text: 'Cool! See you there.' });
                    // Only re-render if chat is still open
                    if(document.getElementById('chatMessages')) {
                        const chatList = document.getElementById('chatMessages');
                        chatList.innerHTML = ''; // quick hack to clear before redraw or better logic
                        renderChatModal();
                    }
                }, 1500);
                input.focus();
            }
        }

        // Start App
        init();

    </script>
</body>
</html>
